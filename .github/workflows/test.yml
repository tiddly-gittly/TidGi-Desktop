name: Test

on:
  workflow_call:
  push:
    branches:
      - master
      - develop
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '.vscode'
  pull_request:
    branches:
      - master
    paths-ignore:
      - 'docs/**'
      - 'README.md'
      - '.vscode'

jobs:
  test:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 'latest'
          run_install: false
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            **/node_modules
            ~/.pnpm-store
            ~/.npm
          key: test-${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            test-${{ runner.os }}-node-
      - name: Install dependencies
        run: pnpm install

      - name: Run linting
        run: pnpm run lint
        continue-on-error: true

      - name: Run unit tests
        run: pnpm run test:unit

      - name: Build plugins
        run: pnpm run build:plugin

      - name: Package for testing
        run: pnpm run package:dev

      # Debug system and environment
      - name: Debug system and environment
        run: |
          echo "=== System Information ==="
          uname -a
          echo "macOS version:"
          sw_vers
          echo "Available displays:"
          system_profiler SPDisplaysDataType
          echo "Current user and groups:"
          id
          echo "Environment variables:"
          env | grep -E "(DISPLAY|CI|NODE_ENV)" || echo "No relevant env vars found"
          
      # Debug packaged application
      - name: Debug packaged application
        run: |
          echo "=== Checking packaged application ==="
          ls -la out/
          
          # Find the actual TidGi directory
          TIDGI_DIR=$(find out/ -name "TidGi-*" -type d | head -1)
          if [ -n "$TIDGI_DIR" ]; then
            echo "Found TidGi directory: $TIDGI_DIR"
            ls -la "$TIDGI_DIR"
            
            # Check if it's macOS app bundle
            if [ -d "$TIDGI_DIR/TidGi.app" ]; then
              echo "=== macOS App Bundle Structure ==="
              echo "Contents:"
              ls -la "$TIDGI_DIR/TidGi.app/Contents/"
              echo "Resources:"
              ls -la "$TIDGI_DIR/TidGi.app/Contents/Resources/"
              
              # Check for app.asar
              if [ -f "$TIDGI_DIR/TidGi.app/Contents/Resources/app.asar" ]; then
                echo "✓ app.asar found"
                ls -la "$TIDGI_DIR/TidGi.app/Contents/Resources/app.asar"
              fi
              
              # Check for unpacked app directory
              if [ -d "$TIDGI_DIR/TidGi.app/Contents/Resources/app" ]; then
                echo "✓ Unpacked app directory found"
                ls -la "$TIDGI_DIR/TidGi.app/Contents/Resources/app/"
                
                echo "=== Checking node_modules in app ==="
                if [ -d "$TIDGI_DIR/TidGi.app/Contents/Resources/app/node_modules" ]; then
                  echo "✓ node_modules found"
                  echo "node_modules contents (first 20):"
                  ls -la "$TIDGI_DIR/TidGi.app/Contents/Resources/app/node_modules/" | head -20
                  
                  echo "=== Checking for dugite specifically ==="
                  if [ -d "$TIDGI_DIR/TidGi.app/Contents/Resources/app/node_modules/dugite" ]; then
                    echo "✓ dugite found!"
                    ls -la "$TIDGI_DIR/TidGi.app/Contents/Resources/app/node_modules/dugite/"
                    echo "dugite files:"
                    find "$TIDGI_DIR/TidGi.app/Contents/Resources/app/node_modules/dugite/" -type f | head -10
                  else
                    echo "✗ dugite NOT found in node_modules"
                  fi
                  
                  echo "=== Checking for other critical deps ==="
                  for dep in "better-sqlite3" "tiddlywiki"; do
                    if [ -d "$TIDGI_DIR/TidGi.app/Contents/Resources/app/node_modules/$dep" ]; then
                      echo "✓ $dep found"
                    else
                      echo "✗ $dep NOT found"
                    fi
                  done
                else
                  echo "✗ node_modules NOT found in app"
                fi
              else
                echo "✗ Unpacked app directory NOT found"
              fi
            else
              echo "Not a macOS app bundle, checking direct structure"
              ls -la "$TIDGI_DIR/"
            fi
          else
            echo "✗ No TidGi directory found"
            echo "Available directories in out/:"
            find out/ -type d -maxdepth 2
          fi

      - name: Run e2e tests
        run: pnpm run test:e2e
        env:
          CI: true
          # Enable more verbose logging
          DEBUG: "*"
          ELECTRON_ENABLE_LOGGING: true
          ELECTRON_ENABLE_STACK_DUMPING: true
        timeout-minutes: 15

      # Upload test artifacts (screenshots, logs)
      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts
          path: |
            logs/
            cucumber-report.json
          retention-days: 7

      # Upload application logs
      - name: Upload application logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: application-logs
          path: |
            ~/Library/Logs/TidGi/
            userData-dev/logs/
          retention-days: 7
        continue-on-error: true
